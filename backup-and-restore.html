<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Backup and Restore - flow accounting</title><meta name="description" content="Purpose Each company Admin will be responsible for taking (sql) backup of their FA database at regular intervals. In case&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://grapitodesigns.github.io/flow.doc/backup-and-restore.html"><link rel="alternate" type="application/atom+xml" href="https://grapitodesigns.github.io/flow.doc/feed.xml" title="flow accounting - RSS"><link rel="alternate" type="application/json" href="https://grapitodesigns.github.io/flow.doc/feed.json" title="flow accounting - JSON"><meta property="og:title" content="Backup and Restore"><meta property="og:image" content="https://grapitodesigns.github.io/flow.doc/media/website/flow-500.png"><meta property="og:image:width" content="499"><meta property="og:image:height" content="242"><meta property="og:site_name" content="flow accounting"><meta property="og:description" content="Purpose Each company Admin will be responsible for taking (sql) backup of their FA database at regular intervals. In case&hellip;"><meta property="og:url" content="https://grapitodesigns.github.io/flow.doc/backup-and-restore.html"><meta property="og:type" content="article"><link rel="stylesheet" href="https://grapitodesigns.github.io/flow.doc/assets/css/fontawesome-all.min.css?v=85514f933f9e0b82460af63f1a403fa5"><link rel="stylesheet" href="https://grapitodesigns.github.io/flow.doc/assets/css/style.css?v=08429d9dfdee792d7b4282fb057fc507"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://grapitodesigns.github.io/flow.doc/backup-and-restore.html"},"headline":"Backup and Restore","datePublished":"2025-12-01T13:01+05:30","dateModified":"2025-12-01T13:01+05:30","image":{"@type":"ImageObject","url":"https://grapitodesigns.github.io/flow.doc/media/website/flow-500.png","height":242,"width":499},"description":"Purpose Each company Admin will be responsible for taking (sql) backup of their FA database at regular intervals. In case&hellip;","author":{"@type":"Person","name":"Grapito","url":"https://grapitodesigns.github.io/flow.doc/authors/grapito/"},"publisher":{"@type":"Organization","name":"Grapito","logo":{"@type":"ImageObject","url":"https://grapitodesigns.github.io/flow.doc/media/website/flow-500.png","height":242,"width":499}}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="is-preload page-template"><div id="wrapper"><div id="main"><div class="inner"><header id="header"><a class="logo logo-image" href="https://grapitodesigns.github.io/flow.doc/"><img src="https://grapitodesigns.github.io/flow.doc/media/website/flow-500.png" alt="flow accounting" width="499" height="242"></a></header><article class="post"><header class="main post__header"><h1>Backup and Restore</h1></header><div class="post__inner post__entry"><h3>Purpose</h3><p>Each company Admin will be responsible for taking (sql) backup of their FA database at regular intervals. In case upgrades or some bulk transactions go awry, a rollback would be necessary for which the restore option will be a godsend. This however comes with a security vulnerability for now with a variety of workarounds.</p><div class="gallery-wrapper"><div class="gallery" data-is-empty="false" data-translation="Add images" data-columns="1"><figure class="gallery__item"><a href="https://grapitodesigns.github.io/flow.doc/media/posts/128//gallery/FA_BackupRestore.jpg" data-size="806x425"><img loading="lazy" src="https://grapitodesigns.github.io/flow.doc/media/posts/128//gallery/FA_BackupRestore-thumbnail.jpg" alt="" width="720" height="380"></a></figure></div></div><h3>Procedure</h3><p><strong>Setup</strong> =&gt; <strong>Backup and Restore</strong></p><div class="vspace"> </div><h3>Notes</h3><ul><li>Only tables that match the company's prefix will be backedup.</li><li>The <strong>users</strong> and <strong>security_roles</strong> tables will not be restored when <strong>Protect Security Settings</strong> is chosen. All tables are currently always backed up but when <strong>Protect security settings</strong> is selected, the <strong>#_users</strong> and <strong>#_security_roles</strong> tables are not restored.</li><li>On restoration, these tables will first be dropped before being recreated and populated.</li><li>Beware that the username and password for all users too will be overwritten on restoration as also the user preferences, language choices, etc.,.</li><li>These backups are stored in the company's <strong>backup</strong> folder - in the screenshot above, for company 1 it is in <strong>company/1/backup</strong> relative to the webroot.</li><li>Forum Post: Match the source backup file's table prefix to that of the target company before restoration into the latter. Check table prefix from default company.</li><li>The first executable line in <strong>admin/db/maintenance_db.inc</strong> <code>define('EXPORT_MAX_INSERT', 50000);</code> determines the maximum number of records in a single insert statement. Adjust this value depending on the RAM you have available to PHP.</li><li>Stripping <code>AUTO_INCREMENT=xxx </code>from MySQL dumps can be done as instructed here like:</li></ul><div class="vspace"> </div><pre class="escaped">mysqldump -u root -d -R --single-transaction &lt;db&gt; | sed 's/ AUTO_INCREMENT=[0-9]*\b//' | gzip &gt; out.sql.gz
</pre><p class="vspace">or alternatively using <strong>sed</strong> directly on the <strong>sql</strong> file (eg., sql_dump_file.sql) like:</p><div class="vspace"> </div><pre class="escaped">sed 's/ AUTO_INCREMENT=[0-9]*\b//' -i sql_dump_file.sql
</pre><div class="vspace"> </div><h3>Tips and Tricks</h3><ul><li>The backup file naming format is determined in the <strong><em>function</em> db_backup()</strong> in <strong>admin/db/maintenance_db.inc</strong> file around lines 451-459:</li></ul><div class="vspace"> </div><pre class="escaped">function db_backup($conn, $ext='no', $comm='', $tbpref = TB_PREF)
{
	if ($conn['tbpref'] != "")
		$filename = $conn['dbname'] . "_" . $conn['tbpref'] . date("Ymd_Hi") . ".sql";
	else
		$filename = $conn['dbname'] . "_" . date("Ymd_Hi") . ".sql";

	return db_export($conn, clean_file_name($filename), $ext, $comm, $tbpref);
}
</pre><div class="vspace"> </div><h3>Make the backup name more human friendly</h3><p>This can be done by altering the file name by</p><ul><li>inserting a string denoting the company name (with spaces and non alpha-numeric characters either stripped or replaced with underscore)</li><li>extending the date format to include seconds ("<strong>Ymd_His</strong>") will alleviate the edge case of two or more backups being taken within the same minute.</li></ul><div class="vspace"> </div><h3>Exclude some tables from backup</h3><p>To exclude some tables from the backup, replace the following code (Lines 505 to 513) in <strong>admin/db/maintenance_db.inc</strong>:</p><div class="vspace"> </div><pre class="escaped">    // get auto_increment values and names of all tables
    $res = db_query("show table status");
    $all_tables = array();
    while($row = db_fetch($res))
    {
		if (($conn["tbpref"] == "" &amp;&amp; !preg_match('/[0-9]+_/', $row['Name'])) ||
			($conn["tbpref"] != "" &amp;&amp; strpos($row['Name'], $conn["tbpref"]) === 0))
    		$all_tables[] = $row;
    }
</pre><p class="vspace">with the following code:</p><div class="vspace"> </div><pre class="escaped">    // get auto_increment values and names of all tables
    $res = db_query("show table status");
    $all_tables = array();
    $skip_tables_list = Array('users', 'security_roles', 'sql_trail');
	for ($i = 0; $i &lt; count($skip_tables_list); $i++) {
		$skip_tables_list[$i] = $conn["tbpref"].$skip_tables_list[$i];
	}
    while($row = db_fetch($res))
    {
		if (($conn["tbpref"] == "" &amp;&amp; !preg_match('/[0-9]+_/', $row['Name'])) ||
			($conn["tbpref"] != "" &amp;&amp; strpos($row['Name'], $conn["tbpref"]) === 0))
			if (!(in_array($row['Name'], $skip_tables_list, true)))
				$all_tables[] = $row;
    }
</pre><p class="vspace">The <strong>$skip_tables_list</strong> array the names of tables to be skipped (without table prefixes).</p><p class="vspace">The tables missing tables in the backup remain untouched in the database when restored.</p><div class="vspace"> </div><h3>Restoring backup to specific prefix</h3><p>When a new company is created, an entry is made in the <strong>$db_connections</strong> array in the <strong>config_db.php</strong> table for it. This entry contains the prefix to be used and the key for the entry need not be the same as the prefix used.</p><p class="vspace">When companies are deleted out of order as is in practice, finding a missing prefix in the <strong>$db_connections</strong> array would clash with possible non numeric table prefixes and restoring from a deleted company into it's original prefix would be impossible.</p><p class="vspace">The following method simulates situation including the creation of a new company with a specific prefix to enable the restoration of a backup taken with the same prefix earlier:</p><div class="vspace"> </div><ol><li>Create your 3 companies anew so you have 0 (Default), 1,2,3 companies.</li><li>Note down the elements of the <strong>$db_connections</strong> array in the <strong>config_db.php</strong> entries (backup the file).</li><li>Delete company with prefix 1_.</li><li>The entry for the company "1" is removed from the <strong>config_db.php</strong> file</li><li>The value of the variable <strong>$tb_pref_counter</strong> in the <strong>config_db.php</strong> will signal the next prefix - alter it as needed even temporarily so as to create your company "1" again and then revert back.</li></ol><div class="vspace"> </div><h3>Auto backup daily using <strong>cron</strong> (not properly tested):</h3><pre class="escaped">#!/bin/bash
url="https://[host].[domain].[tld]/"
cd "$(dirname "$1")"

curl -s -c my_session -F 'user_name_entry_field=admin' \
                      -F 'password=[password for admin]' \
                      -F 'company_login_name=[companynumber]' ${url} &gt;/dev/null

curl -s -b my_session -F 'creat=Create Backup' ${url}admin/backups.php

echo
rm my_session
</pre><div class="vspace"> </div><h3>Backup Code Analysis</h3><ul><li>The key file where the backup originates is <strong>admin/db/maintenance_db.inc</strong></li><li>In it, the key function that starts the backup is <em>function <strong>db_backup()</strong></em><ul><li>Parameter <strong>$tbpref</strong> makes it generic enabling usage of other prefixes possibly within extensions or in customisations</li><li>Creates the name of the backup sql file and goes to <em>function <strong>db_export()</strong></em></li></ul></li><li>The actual backing up is done in the <em>function <strong>db_export()</strong></em><ul><li>Parameter <strong>$tbpref</strong> makes it generic enabling usage of other prefixes possibly within extensions or in customisations</li><li>If no prefix is there for a company and other companies data resides in the same db, then all tables in the db <em>including those of other companies in it too will get backed up!</em></li><li>Sets <strong>max chunk size</strong> before writing to sql backup file to <strong>2MB</strong> or if present, from <strong>memory_limit</strong> value in <strong>php.ini</strong></li><li>Writes standard parameters to sql backup as <strong>comments</strong></li><li>Writes <em>user comments</em> to sql backup as <strong>comments</strong></li><li>Acquire all table names in db and shortlist them based <em>on prefix</em> or <strong><em>all</em></strong><em> on no prefix</em>!</li><li>SQL comment character hardcoded as "#" throughout</li></ul></li></ul><p class="vspace">If your backup is taking too long, then tune the MySQL server with <strong>mysqltuner</strong>. In debian, install with <code>apt-get install mysqltuner</code>. Usage:</p><div class="vspace"> </div><pre class="escaped">mysqlcheck -o mydbname
mysqltuner
</pre><p class="vspace">and monitor with:</p><div class="vspace"> </div><pre class="escaped">tail -fn0 /var/log/mysql.err
tail -n15 /var/log/mysql.err
vmstat 5 5</pre></div></article></div></div><div id="sidebar"><div class="inner"><div id="search" class="alt"><form action="https://grapitodesigns.github.io/flow.doc/search.html" class="search__form"><input class="search__input" type="search" name="q" placeholder="search..." aria-label="search..." autofocus></form></div><nav id="menu"><header class="major"><h2>Menu</h2></header><ul><li><a href="https://grapitodesigns.github.io/flow.doc/" target="_self">Introduction</a></li><li class="has-submenu"><a href="https://grapitodesigns.github.io/flow.doc/working-with-flow-accounting.html" target="_self" aria-haspopup="true" class="opener">Working with Flow acounting</a><ul class="submenu level-2" aria-hidden="true"><li><a href="https://grapitodesigns.github.io/flow.doc/demo-3.html" target="_self">Sales</a></li><li><a href="https://grapitodesigns.github.io/flow.doc/purchases.html" target="_self">Purchases</a></li><li><a href="https://grapitodesigns.github.io/flow.doc/items-and-inventory.html" target="_self">Items and Inventory</a></li><li><a href="https://grapitodesigns.github.io/flow.doc/manufacturing.html" target="_self">Manufacturing</a></li><li><a href="https://grapitodesigns.github.io/flow.doc/fixed-assets.html" target="_self">Fixed Assets</a></li><li><a href="https://grapitodesigns.github.io/flow.doc/dimensions.html" target="_self">Dimensions</a></li><li><a href="https://grapitodesigns.github.io/flow.doc/banking-and-general-ledger.html" target="_self">Banking And General Ledger</a></li><li><a href="https://grapitodesigns.github.io/flow.doc/setup.html" target="_self">Setup</a></li><li><a href="https://grapitodesigns.github.io/flow.doc/purchases.html" target="_self">Purchases</a></li></ul></li><li class="has-submenu"><a href="https://grapitodesigns.github.io/flow.doc/the-superadmin.html" target="_self" aria-haspopup="true" class="opener">The Super Admin</a><ul class="submenu level-2" aria-hidden="true"><li><a href="https://grapitodesigns.github.io/flow.doc/createupdate-companies-installupdate-languages-installactivate-extensions-software-upgrade.html" target="_self">Create/Update Companies, Install/Update Languages, Install/Activate Extensions, Software Upgrade</a></li></ul></li></ul></nav><section><header class="major"><h2>Get in touch</h2></header><p>Sed varius enim lorem ullamcorper dolore aliquam aenean ornare velit lacus,ac varius enim lorem ullamcorper dolore. Proin sed aliqu facilisis ante interdum. Sed nulla amet lorem feugiat tempus aliquam.</p><ul class="contact"><li class="icon solid fa-envelope"><a href="#">information@untitled.tld</a></li><li class="icon solid fa-phone">(000) 000-0000</li><li class="icon solid fa-home">1234 Somewhere Road #8254<br>Nashville, TN 00000-0000</li></ul></section><footer id="footer"><p class="copyright">© Editorial 2 - All rights reserved<br>Design by: <a href="https://html5up.net" target="_blank" rel="noopener">HTML5 UP</a>, Powered by Publii</p></footer></div></div></div><script src="https://grapitodesigns.github.io/flow.doc/assets/js/jquery.min.js?v=7c14a783dfeb3d238ccd3edd840d82ee"></script><script src="https://grapitodesigns.github.io/flow.doc/assets/js/browser.min.js?v=c07298dd19048a8a69ad97e754dfe8d0"></script><script src="https://grapitodesigns.github.io/flow.doc/assets/js/breakpoints.min.js?v=81a479eb099e3b187613943b085923b8"></script><script src="https://grapitodesigns.github.io/flow.doc/assets/js/util.min.js?v=cbdaf7c20ac2883c77ae23acfbabd47e"></script><script src="https://grapitodesigns.github.io/flow.doc/assets/js/main.min.js?v=08add7f6d435054ad38ec38d7cf8be40"></script><script>var images=document.querySelectorAll("img[loading]");for(var i=0;i<images.length;i++){if(images[i].complete){images[i].classList.add("is-loaded")}else{images[i].addEventListener("load",function(){this.classList.add("is-loaded")},false)}};</script></body></html>